<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AmeriDex Order Form</title>

<style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --error: #dc2626;
        --warning: #d97706;
        --light: #f3f4f6;
        --gray: #6b7280;
        --dark: #1f2937;
    }

    body {
        font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
        background: #f8fafc;
        color: var(--dark);
        margin: 0;
        line-height: 1.55;
    }

    .container {
        max-width: 1180px;
        margin: 0 auto;
        padding: 1.5rem;
    }

    header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        text-align: center;
        padding: 2rem 1rem;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    }

    section {
        background: white;
        border-radius: 12px;
        padding: 1.75rem;
        margin-bottom: 1.75rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    h2 {
        margin-top: 0;
        color: var(--primary-dark);
    }

    label {
        font-weight: 600;
        margin: 1rem 0 0.4rem;
        font-size: 0.96rem;
    }

    .checkbox-label {
        display: flex;
        align-items: center;
        gap: 0.6rem;
        margin: 0.9rem 0;
        font-weight: 500;
    }

    input, select, textarea {
        width: 100%;
        padding: 0.75rem 0.9rem;
        border: 1.5px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.15s;
        box-sizing: border-box;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3.5px rgba(37,99,235,0.18);
    }

    input:invalid:not(:placeholder-shown), .invalid {
        border-color: var(--error);
        background-color: #fef2f2;
    }

    .error-text {
        color: var(--error);
        font-size: 0.84rem;
        margin-top: 0.35rem;
        min-height: 1.2em;
    }

    .address-grid {
        display: grid;
        grid-template-columns: 3fr 2fr 1fr 1fr;
        gap: 1rem;
    }

    @media (max-width: 900px) {
        .address-grid { grid-template-columns: 1fr 1fr; }
    }

    @media (max-width: 600px) {
        .address-grid { grid-template-columns: 1fr; }
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.25rem 0;
    }

    th, td {
        padding: 0.9rem 0.8rem;
        border: 1px solid #e2e8f0;
        text-align: left;
    }

    th {
        background: var(--light);
        font-weight: 600;
        color: var(--dark);
    }

    .preview-img {
        width: 52px;
        height: 52px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        vertical-align: middle;
        margin-left: 0.6rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: white;
        padding: 1.8rem;
        border-radius: 12px;
        max-width: 92%;
        max-height: 88vh;
        position: relative;
        text-align: center;
    }

    .close-modal {
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 2.4rem;
        color: #64748b;
        cursor: pointer;
    }

    button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.8rem 1.6rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    button:hover { background: var(--primary-dark); }

    button.danger {
        background: #ef4444;
        padding: 0.5rem 1rem;
        font-size: 0.92rem;
    }

    .total-display {
        font-size: 1.48rem;
        font-weight: 700;
        color: var(--primary-dark);
        text-align: right;
        margin: 1.2rem 0;
        padding: 1rem;
        background: #eff6ff;
        border-radius: 10px;
    }

    .dexerdry-info {
        font-size: 0.88rem;
        color: #475569;
        margin-top: 0.4rem;
    }

    .custom-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.8rem;
        margin-top: 0.6rem;
    }

    @media (max-width: 820px) {
        .custom-fields { grid-template-columns: 1fr; }

        table thead { display: none; }

        tr {
            display: block;
            margin-bottom: 1.4rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #fafafa;
        }

        td {
            display: block;
            border: none;
            position: relative;
            padding: 0.8rem 1rem 0.8rem 48%;
        }

        td:before {
            content: attr(data-label);
            position: absolute;
            left: 1rem;
            width: 42%;
            font-weight: 600;
            color: #475569;
        }
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- Google Places API - REPLACE WITH YOUR OWN KEY -->
<script src="https://api.geoapify.com/v1/geocode/autocomplete?text=Mosco&apiKey=4440450d4460462c92fe521f3cb59976

</head>
<body>

<div class="container">

    <header>
        <h1>AmeriDex Order Form</h1>
        <p style="margin:0.6rem 0 0; opacity:0.9;">Sales Rep Tool</p>
    </header>

    <section>
        <h2>Customer Information</h2>

        <label>Name *</label>
        <input type="text" id="cust-name" required>
        <div class="error-text" id="err-name"></div>

        <label>Company</label>
        <input type="text" id="cust-company">
        <div class="error-text" id="err-company"></div>

        <label>Address *</label>
        <div class="address-grid">
            <div>
                <input type="text" id="cust-street" placeholder="Street address" required>
                <div class="error-text" id="err-street"></div>
            </div>
            <div>
                <input type="text" id="cust-city" placeholder="City" required>
            </div>
            <div>
                <input type="text" id="cust-state" placeholder="State" maxlength="2" required>
            </div>
            <div>
                <input type="text" id="cust-zip" placeholder="ZIP" required pattern="\d{5}(-\d{4})?">
            </div>
        </div>

        <label>Phone</label>
        <input type="tel" id="cust-phone" placeholder="(XXX) XXX-XXXX">

        <label>Email</label>
        <input type="email" id="cust-email" placeholder="customer@example.com">
    </section>

    <section>
        <h2>Shipping Information</h2>

        <label class="checkbox-label">
            <input type="checkbox" id="same-as-customer" checked> Same as customer address
        </label>

        <div id="shipping-fields" style="display:none;">
            <div class="address-grid">
                <div>
                    <input type="text" id="ship-street" placeholder="Shipping street address">
                </div>
                <div>
                    <input type="text" id="ship-city" placeholder="City">
                </div>
                <div>
                    <input type="text" id="ship-state" placeholder="State" maxlength="2">
                </div>
                <div>
                    <input type="text" id="ship-zip" placeholder="ZIP" pattern="\d{5}(-\d{4})?">
                </div>
            </div>
        </div>

        <label>Preferred Delivery Date</label>
        <input type="date" id="pref-delivery">
    </section>

    <section>
        <h2>Order Configuration</h2>

        <label class="checkbox-label">
            <input type="checkbox" id="use-calculator"> Use Deck Calculator (recommends System Boards)
        </label>

        <div id="calculator-panel" style="display:none; margin-top:1.4rem;">
            <label>Deck Length (ft)</label>
            <input type="number" id="deck-length" step="0.1" min="1" placeholder="e.g. 24">

            <label>Deck Width (ft)</label>
            <input type="number" id="deck-width" step="0.1" min="1" placeholder="e.g. 16">

            <label>Board Orientation</label>
            <select id="board-orientation">
                <option value="perpendicular">Perpendicular to length (recommended)</option>
                <option value="parallel">Parallel to length</option>
            </select>

            <button type="button" id="calculate-suggest" style="margin-top:1.1rem;">Calculate & Suggest</button>

            <div id="calc-feedback" style="margin-top:1.2rem; padding:0.9rem; background:#e0f2fe; border-radius:8px; min-height:3.2rem;"></div>
        </div>

        <label class="checkbox-label">
            <input type="checkbox" id="picture-framing"> Picture Framing
        </label>
        <div class="dexerdry-info" id="framing-note" style="display:none; color:var(--warning);">
            → Please add Solid Edge Boards manually for framing
        </div>

        <label class="checkbox-label">
            <input type="checkbox" id="stairs-needed"> Stairs
        </label>
        <div class="dexerdry-info" id="stairs-note" style="display:none; color:var(--warning);">
            → Please add Solid Edge Boards manually for stairs
        </div>
    </section>

    <section>
        <h2>Line Items</h2>
        <div id="fastener-suggestion" class="dexerdry-info" style="margin-bottom:1.2rem;"></div>

        <table id="order-lines">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Color</th>
                    <th>Length ft</th>
                    <th>Qty</th>
                    <th>Dexerdry ft</th>
                    <th>Unit Price</th>
                    <th>Subtotal</th>
                    <th></th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>

        <button type="button" id="add-line" style="margin-top:1rem;">+ Add Line Item</button>
    </section>

    <section>
        <h2>Additional Information</h2>
        <label>Special Instructions / Production Notes</label>
        <textarea id="special-notes" rows="3" placeholder="e.g. special layout requirements, delivery instructions..."></textarea>

        <label>Internal Sales Notes (not visible to customer)</label>
        <textarea id="internal-notes" rows="2"></textarea>
    </section>

    <section>
        <h2>Attachments</h2>
        <input type="file" id="attachments" multiple accept="image/*,.pdf">
        <div class="error-text" id="file-size-warning"></div>
    </section>

    <div class="total-display" id="grand-total-display">
        Estimated Total: $0.00
    </div>

    <section style="text-align:center; padding-bottom:2rem;">
        <button id="reset-form">Reset Form</button>
        <button id="export-pdf">Export PDF</button>
        <button id="send-email">Prepare Email → Submit</button>

        <div id="submit-feedback" style="margin-top:1.4rem; color:#15803d; font-weight:600; min-height:1.6em;"></div>
    </section>

    <!-- Color Preview Modal -->
    <div id="preview-modal" class="modal">
        <div class="modal-content">
            <span class="close-modal" aria-label="Close preview">&times;</span>
            <img id="large-color-preview" src="" alt="Color sample large view" style="max-width:100%; max-height:68vh; border-radius:10px;">
            <div id="color-name-display" style="margin-top:1.1rem; font-size:1.2rem; font-weight:600;"></div>
        </div>
    </div>

</div>

<script>
// ============================================================================
// CONFIGURATION
// ============================================================================

const CONFIG = {
    prices: {
        system:    8.00,
        grooved:   6.00,
        solid:     6.00,
        dexdry:    2.00,
        screws:   37.00,
        plugs:   33.79
    },
    board: {
        effectiveWidthFt: (5.5 + 0.125) / 12,
        wasteFactor: 1.10,
        standardLengths: [12, 16, 20],
        defaultLength: 16,
        maxLength: 40
    },
    fasteners: {
        joistSpacingInches: 16,
        screwsPerIntersection: 2,
        screwsPerBox: 375
    }
};

const PRODUCTS = {
    system:   { name: "AmeriDex System Boards (Grooved + Dexerdry)", hasColor: true,  isLengthBased: true,  bundleDex: true  },
    grooved:  { name: "Grooved Deck Boards (no Dexerdry)",           hasColor: true,  isLengthBased: true,  bundleDex: false },
    solid:    { name: "Solid Edge Deck Boards",                      hasColor: true,  isLengthBased: true,  bundleDex: false },
    dexdry:   { name: "Dexerdry Seals (standalone)",                 hasColor: false, isLengthBased: true,  bundleDex: false },
    screws:   { name: "Epoxy-Coated Screws",                         hasColor: false, isLengthBased: false, bundleDex: false },
    plugs:    { name: "Color-Matching Plugs",                        hasColor: false, isLengthBased: false, bundleDex: false },
    custom:   { name: "Custom / Manual Item",                        hasColor: false, isLengthBased: false, bundleDex: false }
};

const COLORS = ["Driftwood","Khaki","Slate","Beachwood","Chestnut","Redwood","Hazelnut"];

let lines = [];
let deck = { length: 0, width: 0, orientation: "perpendicular" };

const tbody = document.querySelector("#order-lines tbody");
const modal = document.getElementById("preview-modal");
const largeImg = document.getElementById("large-color-preview");
const colorTitle = document.getElementById("color-name-display");

// ============================================================================
// EVENT LISTENERS & INITIALIZATION
// ============================================================================

document.getElementById("use-calculator").addEventListener("change", e => {
    document.getElementById("calculator-panel").style.display = e.target.checked ? "block" : "none";
});

["picture-framing", "stairs-needed"].forEach(id => {
    document.getElementById(id).addEventListener("change", e => {
        document.getElementById(id.replace("-needed","") + "-note").style.display = e.target.checked ? "block" : "none";
    });
});

document.getElementById("add-line").onclick = () => addLine();

document.getElementById("calculate-suggest").onclick = runCalculator;

modal.querySelector(".close-modal").onclick = () => modal.style.display = "none";
modal.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

document.getElementById("reset-form").onclick = () => {
    if (!confirm("Reset entire form? All data will be lost.")) return;
    lines = [];
    renderLines();
    updateTotalsAndHints();
    document.querySelectorAll("input:not([type=checkbox]), textarea, select").forEach(el => el.value = "");
    document.querySelectorAll("input[type=checkbox]").forEach(cb => cb.checked = cb.id === "same-as-customer");
    document.getElementById("shipping-fields").style.display = "none";
    document.querySelectorAll(".error-text").forEach(el => el.textContent = "");
    document.getElementById("use-calculator").checked = false;
    document.getElementById("calculator-panel").style.display = "none";
};

document.getElementById("export-pdf").onclick = generatePDF;
document.getElementById("send-email").onclick = prepareEmailSubmission;

// Same as customer toggle
document.getElementById("same-as-customer").addEventListener("change", function() {
    document.getElementById("shipping-fields").style.display = this.checked ? "none" : "block";
    if (this.checked) {
        ['street','city','state','zip'].forEach(part => {
            document.getElementById(`ship-${part}`).value = document.getElementById(`cust-${part}`).value;
        });
    }
});

// Google Places Autocomplete
function initAutocomplete() {
    if (!window.google?.maps?.places) return;

    const streetInput = document.getElementById('cust-street');
    const autocomplete = new google.maps.places.Autocomplete(streetInput, {
        types: ['address'],
        componentRestrictions: { country: 'us' }
    });

    autocomplete.addListener('place_changed', () => {
        const place = autocomplete.getPlace();
        if (!place.geometry) return;

        let streetNumber = '', route = '';

        place.address_components?.forEach(comp => {
            const t = comp.types;
            if (t.includes('street_number')) streetNumber = comp.long_name;
            if (t.includes('route')) route = comp.long_name;
            if (t.includes('locality')) document.getElementById('cust-city').value = comp.long_name;
            if (t.includes('administrative_area_level_1')) document.getElementById('cust-state').value = comp.short_name;
            if (t.includes('postal_code')) document.getElementById('cust-zip').value = comp.long_name;
        });

        streetInput.value = [streetNumber, route].filter(Boolean).join(' ');
    });
}

google?.maps?.event?.addDomListener(window, 'load', initAutocomplete);

// ============================================================================
// LINE ITEMS FUNCTIONS
// ============================================================================

function addLine(defaultType = "system") {
    lines.push({
        type: defaultType,
        color: defaultType !== "custom" ? COLORS[0] : "",
        length: CONFIG.board.defaultLength,
        qty: 1,
        dexdryOverride: null,
        priceOverride: null,
        customDesc: "",
        customUnitPrice: 0
    });
    renderLines();
    updateTotalsAndHints();
}

function renderLines() {
    tbody.innerHTML = "";

    lines.forEach((item, i) => {
        const p = PRODUCTS[item.type] || PRODUCTS.custom;
        const tr = document.createElement("tr");

        // Product
        let td = createTd("Product");
        const sel = document.createElement("select");
        Object.keys(PRODUCTS).forEach(k => {
            const o = document.createElement("option");
            o.value = k;
            o.textContent = PRODUCTS[k].name;
            if (k === item.type) o.selected = true;
            sel.appendChild(o);
        });
        sel.onchange = () => {
            item.type = sel.value;
            if (!p.isLengthBased) item.length = null;
            if (item.type !== "system") item.dexdryOverride = null;
            if (item.type !== "custom") {
                item.customDesc = "";
                item.customUnitPrice = 0;
            }
            renderLines();
            updateTotalsAndHints();
        };
        td.appendChild(sel);
        tr.appendChild(td);

        // Color
        td = createTd("Color");
        if (p.hasColor) {
            const csel = document.createElement("select");
            COLORS.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                if (c === item.color) o.selected = true;
                csel.appendChild(o);
            });
            csel.onchange = e => { item.color = e.target.value; updateTotalsAndHints(); };

            const img = document.createElement("img");
            img.src = `colors/${item.color.toLowerCase()}.jpg` || 'https://via.placeholder.com/52?text=?';
            img.className = "preview-img";
            img.alt = `${item.color} preview`;
            img.onclick = () => {
                largeImg.src = img.src;
                colorTitle.textContent = item.color;
                modal.style.display = "flex";
            };
            td.append(csel, img);
        }
        tr.appendChild(td);

        // Length
        td = createTd("Length ft");
        if (p.isLengthBased) {
            if (["system","grooved","solid"].includes(item.type)) {
                const lsel = document.createElement("select");
                CONFIG.board.standardLengths.forEach(l => {
                    const o = document.createElement("option");
                    o.value = l;
                    o.textContent = l;
                    if (l === item.length) o.selected = true;
                    lsel.appendChild(o);
                });
                const cust = document.createElement("option");
                cust.value = "custom"; cust.textContent = "Custom";
                if (!CONFIG.board.standardLengths.includes(item.length)) cust.selected = true;
                lsel.appendChild(cust);

                lsel.onchange = () => {
                    if (lsel.value === "custom") {
                        const val = prompt(`Custom length (1–${CONFIG.board.maxLength} ft):`, item.length);
                        const num = parseFloat(val);
                        if (!isNaN(num) && num > 0 && num <= CONFIG.board.maxLength) item.length = num;
                    } else {
                        item.length = parseFloat(lsel.value);
                    }
                    renderLines();
                    updateTotalsAndHints();
                };
                td.appendChild(lsel);
            } else {
                const inp = document.createElement("input");
                inp.type = "number"; inp.step = "0.1"; inp.min = "0.1";
                inp.value = item.length || "";
                inp.oninput = e => { item.length = parseFloat(e.target.value)||0; updateTotalsAndHints(); };
                td.appendChild(inp);
            }
        }
        tr.appendChild(td);

        // Qty + Custom fields
        td = createTd("Qty");
        const q = document.createElement("input");
        q.type = "number"; q.min = "1"; q.value = item.qty;
        q.oninput = e => { item.qty = Math.max(1, parseInt(e.target.value)||1); updateTotalsAndHints(); };
        td.appendChild(q);

        if (item.type === "custom") {
            const wrapper = document.createElement("div");
            wrapper.className = "custom-fields";
            const desc = document.createElement("input");
            desc.placeholder = "Description"; desc.value = item.customDesc;
            desc.oninput = e => item.customDesc = e.target.value;
            const uprice = document.createElement("input");
            uprice.type = "number"; uprice.step = "0.01"; uprice.min = "0";
            uprice.placeholder = "Unit $"; uprice.value = item.customUnitPrice;
            uprice.oninput = e => { item.customUnitPrice = parseFloat(e.target.value)||0; updateTotalsAndHints(); };
            wrapper.append(desc, uprice);
            td.appendChild(wrapper);
        }
        tr.appendChild(td);

        // Dexerdry ft
        td = createTd("Dexerdry ft");
        if (item.type === "system") {
            const calc = (item.qty - 1) * (item.length||0) * CONFIG.board.wasteFactor;
            const shown = item.dexdryOverride ?? calc;

            const span = document.createElement("span");
            span.textContent = shown.toFixed(1);
            span.style.color = item.dexdryOverride !== null ? "var(--primary)" : "#64748b";

            const btn = document.createElement("button");
            btn.textContent = item.dexdryOverride !== null ? "Reset" : "Override";
            btn.style.fontSize = "0.82rem";
            btn.style.marginLeft = "0.6rem";
            btn.onclick = () => {
                if (item.dexdryOverride !== null) {
                    item.dexdryOverride = null;
                } else {
                    const v = prompt("Override Dexerdry ft:", shown.toFixed(1));
                    const n = parseFloat(v);
                    if (!isNaN(n) && n >= 0) item.dexdryOverride = n;
                }
                renderLines();
                updateTotalsAndHints();
            };
            td.append(span, btn);
        }
        tr.appendChild(td);

        // Price
        td = createTd("Unit Price");
        const priceIn = document.createElement("input");
        priceIn.type = "number"; priceIn.step = "0.01"; priceIn.min = "0";
        priceIn.value = item.priceOverride ?? "";
        priceIn.placeholder = (CONFIG.prices[item.type] || 0).toFixed(2);
        priceIn.oninput = e => { item.priceOverride = parseFloat(e.target.value); updateTotalsAndHints(); };
        td.appendChild(priceIn);
        tr.appendChild(td);

        // Subtotal
        td = createTd("Subtotal");
        td.id = `sub-${i}`;
        tr.appendChild(td);

        // Remove
        td = createTd("");
        const rm = document.createElement("button");
        rm.textContent = "×"; rm.className = "danger";
        rm.onclick = () => { lines.splice(i,1); renderLines(); updateTotalsAndHints(); };
        td.appendChild(rm);
        tr.appendChild(td);

        tbody.appendChild(tr);
    });
}

function createTd(label) {
    const td = document.createElement("td");
    td.setAttribute("data-label", label);
    return td;
}

function getLineSubtotal(item) {
    const base = item.priceOverride ?? CONFIG.prices[item.type] ?? 0;

    if (item.type === "system") {
        const boardFt = item.qty * (item.length || 0);
        const dexFt = item.dexdryOverride ?? (item.qty - 1) * (item.length || 0) * CONFIG.board.wasteFactor;
        return (boardFt * CONFIG.prices.grooved) + (dexFt * CONFIG.prices.dexdry);
    }

    if (["system","grooved","solid","dexdry"].includes(item.type)) {
        return item.qty * (item.length || 0) * base;
    }

    return item.qty * base;
}

function updateTotalsAndHints() {
    let total = 0;
    let grooved = 0;

    lines.forEach((item, i) => {
        const sub = getLineSubtotal(item);
        total += sub;
        document.getElementById(`sub-${i}`).textContent = "$" + sub.toFixed(2);

        if (["system","grooved"].includes(item.type)) grooved += item.qty;
    });

    document.getElementById("grand-total-display").textContent =
        `Estimated Total: $${total.toFixed(2)}`;

    // Fastener hint (simplified)
    if (grooved > 0 && deck.length > 0) {
        document.getElementById("fastener-suggestion").innerHTML =
            `Fastener estimate: ≈ ${Math.ceil(grooved * 8 / 375)} boxes each of screws & plugs (rough)`;
    } else {
        document.getElementById("fastener-suggestion").innerHTML = "";
    }
}

function runCalculator() {
    deck.length = parseFloat(document.getElementById("deck-length").value) || 0;
    deck.width = parseFloat(document.getElementById("deck-width").value) || 0;
    deck.orientation = document.getElementById("board-orientation").value;

    if (deck.length < 1 || deck.width < 1) return alert("Please enter valid deck dimensions");

    const span = deck.orientation === "perpendicular" ? deck.length : deck.width;
    const run = deck.orientation === "perpendicular" ? deck.width : deck.length;

    const boards = Math.ceil(span / CONFIG.board.effectiveWidthFt * CONFIG.board.wasteFactor);
    const dexdryFt = (boards - 1) * run * CONFIG.board.wasteFactor;

    document.getElementById("calc-feedback").innerHTML =
        `Suggested: ${boards} System Boards @ ${run.toFixed(1)} ft each<br>` +
        `Dexerdry needed: ${dexdryFt.toFixed(1)} ft (incl. waste)`;

    if (confirm("Add suggested System Boards?")) {
        addLine("system");
        const last = lines[lines.length-1];
        last.qty = boards;
        last.length = Math.min(20, Math.round(run / 4) * 4); // nearest multiple of 4
        renderLines();
        updateTotalsAndHints();
    }
}

// ============================================================================
// FORM SUBMISSION & EXPORT
// ============================================================================

function validateForm() {
    let ok = true;

    const required = [
        {id:"cust-name", msg:"Name is required"},
        {id:"cust-street", msg:"Street address is required"},
        {id:"cust-city", msg:"City is required"},
        {id:"cust-state", msg:"State is required"},
        {id:"cust-zip", msg:"ZIP code is required"}
    ];

    required.forEach(f => {
        const el = document.getElementById(f.id);
        const errId = `err-${f.id.split('-')[1] || f.id.split('-')[0]}`;
        if (!el.value.trim()) {
            document.getElementById(errId).textContent = f.msg;
            el.classList.add("invalid");
            ok = false;
        } else {
            document.getElementById(errId).textContent = "";
            el.classList.remove("invalid");
        }
    });

    // File size
    let size = 0;
    [...document.getElementById("attachments").files].forEach(f => size += f.size);
    document.getElementById("file-size-warning").textContent =
        size > 10*1024*1024 ? "Total attachments > 10 MB" : "";
    if (size > 10*1024*1024) ok = false;

    if (lines.length === 0) {
        alert("Please add at least one line item");
        return false;
    }

    return ok;
}

function generateOrderText() {
    const name = document.getElementById("cust-name").value.trim() || "Customer";
    let customerAddr = [
        document.getElementById("cust-street").value,
        document.getElementById("cust-city").value,
        document.getElementById("cust-state").value,
        document.getElementById("cust-zip").value
    ].filter(Boolean).join(", ");

    let shipping = document.getElementById("same-as-customer").checked
        ? "(same as customer)"
        : [
            document.getElementById("ship-street").value,
            document.getElementById("ship-city").value,
            document.getElementById("ship-state").value,
            document.getElementById("ship-zip").value
          ].filter(Boolean).join(", ");

    let text = `AmeriDex Order – ${name}\n\n`;
    text += `Customer:\n  Name: ${name}\n  Address: ${customerAddr}\n`;
    text += `Phone: ${document.getElementById("cust-phone").value || "—"} \n`;
    text += `Email: ${document.getElementById("cust-email").value || "—"} \n\n`;

    text += "Shipping:\n  " + shipping + "\n";
    const date = document.getElementById("pref-delivery").value;
    if (date) text += `Preferred date: ${date}\n\n`;

    text += "Items:\n";
    lines.forEach(item => {
        const p = PRODUCTS[item.type];
        let desc = p.name;
        if (item.type === "custom") desc = item.customDesc || "Custom";
        const color = item.color ? ` (${item.color})` : "";
        const len = item.length ? ` × ${item.length} ft` : "";
        const price = item.priceOverride ?? CONFIG.prices[item.type] ?? 0;
        const sub = getLineSubtotal(item);
        text += `• ${desc}${color}${len}  Qty: ${item.qty}  $${price.toFixed(2)}  Subtotal: $${sub.toFixed(2)}\n`;
    });

    const total = lines.reduce((s, i) => s + getLineSubtotal(i), 0);
    text += `\nEstimated Total: $${total.toFixed(2)}\n\n`;

    text += "Special Instructions:\n" + (document.getElementById("special-notes").value.trim() || "—") + "\n\n";
    const notes = document.getElementById("internal-notes").value.trim();
    if (notes) text += "Internal Notes:\n" + notes + "\n";

    return text;
}

function prepareEmailSubmission() {
    if (!validateForm()) return;

    const body = generateOrderText();
    const subject = `AmeriDex Order - ${document.getElementById("cust-name").value.trim() || "New Order"}`;

    window.location.href = `mailto:sales@ameridex.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

    document.getElementById("submit-feedback").textContent =
        "Email client opened – remember to attach files if needed!";
}

function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 18;

    doc.setFontSize(18);
    doc.text("AmeriDex Order Estimate", 105, y, { align: "center" });
    y += 12;

    // Customer info...
    doc.setFontSize(11);
    doc.text("Customer:", 15, y); y += 7;
    doc.setFontSize(10);
    doc.text(document.getElementById("cust-name").value, 25, y); y += 6;
    doc.text(document.getElementById("cust-street").value, 25, y); y += 6;
    doc.text([
        document.getElementById("cust-city").value,
        document.getElementById("cust-state").value,
        document.getElementById("cust-zip").value
    ].filter(Boolean).join(", "), 25, y); y += 12;

    // Items...
    doc.setFontSize(11);
    doc.text("Order Items:", 15, y); y += 8;
    doc.setFontSize(9);
    lines.forEach(item => {
        const desc = PRODUCTS[item.type]?.name || item.customDesc || "Custom";
        const line = `${desc} × ${item.qty}   $${getLineSubtotal(item).toFixed(2)}`;
        doc.text(line.substring(0,90), 20, y);
        y += 7;
        if (y > 270) { doc.addPage(); y = 20; }
    });

    const total = lines.reduce((s,i)=>s+getLineSubtotal(i),0);
    doc.setFontSize(12);
    doc.text(`Total Estimate: $${total.toFixed(2)}`, 20, y + 10);

    doc.save("AmeriDex_Order.pdf");
}

// ============================================================================
// STARTUP
// ============================================================================

renderLines();
updateTotalsAndHints();

</script>
</body>
</html>
