<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AmeriDex Order Form • Improved v2</title>

<style>
    :root {
        --primary: #2563eb;
        --primary-dark: #1d4ed8;
        --error: #dc2626;
        --warning: #d97706;
        --light: #f3f4f6;
        --gray: #6b7280;
        --dark: #1f2937;
    }

    body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #f8fafc;
        color: var(--dark);
        margin: 0;
        line-height: 1.55;
    }

    .container { max-width: 1180px; margin: 0 auto; padding: 1.5rem; }

    header {
        background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
        color: white;
        text-align: center;
        padding: 2rem 1rem;
        border-radius: 0 0 16px 16px;
        box-shadow: 0 6px 12px rgba(0,0,0,0.12);
    }

    section {
        background: white;
        border-radius: 12px;
        padding: 1.75rem;
        margin-bottom: 1.75rem;
        box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }

    h2 { margin-top: 0; color: var(--primary-dark); }

    label {
        font-weight: 600;
        display: block;
        margin: 1rem 0 0.4rem;
        font-size: 0.96rem;
    }

    input, select, textarea {
        width: 100%;
        padding: 0.75rem 0.9rem;
        border: 1.5px solid #d1d5db;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.15s;
        box-sizing: border-box;
    }

    input:focus, select:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3.5px rgba(37,99,235,0.18);
    }

    input:invalid:not(:placeholder-shown), .invalid {
        border-color: var(--error);
        background-color: #fef2f2;
    }

    .error-text {
        color: var(--error);
        font-size: 0.84rem;
        margin-top: 0.35rem;
        min-height: 1.2em;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.25rem 0;
    }

    th, td {
        padding: 0.9rem 0.8rem;
        border: 1px solid #e2e8f0;
    }

    th {
        background: var(--light);
        font-weight: 600;
        color: var(--dark);
        text-align: left;
    }

    .preview-img {
        width: 52px;
        height: 52px;
        object-fit: cover;
        border-radius: 6px;
        cursor: pointer;
        vertical-align: middle;
        margin-left: 0.6rem;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.7);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        backdrop-filter: blur(4px);
    }

    .modal-content {
        background: white;
        padding: 1.8rem;
        border-radius: 12px;
        max-width: 92%;
        max-height: 88vh;
        position: relative;
        text-align: center;
    }

    .close-modal {
        position: absolute;
        top: 12px;
        right: 18px;
        font-size: 2.4rem;
        color: #64748b;
        cursor: pointer;
    }

    button {
        background: var(--primary);
        color: white;
        border: none;
        padding: 0.8rem 1.6rem;
        border-radius: 8px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    button:hover { background: var(--primary-dark); }

    button.danger {
        background: #ef4444;
        padding: 0.5rem 1rem;
        font-size: 0.92rem;
    }

    .total-display {
        font-size: 1.48rem;
        font-weight: 700;
        color: var(--primary-dark);
        text-align: right;
        margin: 1.2rem 0;
        padding: 1rem;
        background: #eff6ff;
        border-radius: 10px;
    }

    .dexerdry-info {
        font-size: 0.88rem;
        color: #475569;
        margin-top: 0.4rem;
    }

    .custom-fields {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.8rem;
        margin-top: 0.6rem;
    }

    @media (max-width: 820px) {
        .custom-fields { grid-template-columns: 1fr; }

        table thead { display: none; }

        tr {
            display: block;
            margin-bottom: 1.4rem;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            background: #fafafa;
        }

        td {
            display: block;
            border: none;
            position: relative;
            padding: 0.8rem 1rem 0.8rem 48%;
        }

        td:before {
            content: attr(data-label);
            position: absolute;
            left: 1rem;
            width: 42%;
            font-weight: 600;
            color: #475569;
        }
    }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body>

<div class="container">

<header>
    <h1>AmeriDex Order Form</h1>
    <p style="margin:0.6rem 0 0; opacity:0.9;">Improved • Sales Rep Edition</p>
</header>

<section>
    <h2>Customer Information</h2>
    
    <label>Name *</label>
    <input type="text" id="cust-name" required aria-required="true">
    <div class="error-text" id="err-name"></div>

    <label>Company *</label>
    <input type="text" id="cust-company" required>
    <div class="error-text" id="err-company"></div>

    <label>Address *</label>
    <textarea id="cust-address" rows="3" required></textarea>
    <div class="error-text" id="err-address"></div>

    <label>Phone *</label>
    <input type="tel" id="cust-phone" required pattern="[0-9 ()+-]{7,}" title="Please enter a valid phone number">
    <div class="error-text" id="err-phone"></div>

    <label>Email *</label>
    <input type="email" id="cust-email" required>
    <div class="error-text" id="err-email"></div>
</section>

<section>
    <h2>Order Configuration</h2>

    <label>
        <input type="checkbox" id="use-calculator"> Use Deck Calculator (recommends System Boards)
    </label>

    <div id="calculator-panel" style="display:none; margin-top:1.4rem;">
        <label>Deck Length (ft)</label>
        <input type="number" id="deck-length" step="0.1" min="1" placeholder="e.g. 24">

        <label>Deck Width (ft)</label>
        <input type="number" id="deck-width" step="0.1" min="1" placeholder="e.g. 16">

        <label>Board Orientation</label>
        <select id="board-orientation">
            <option value="perpendicular">Perpendicular to length (recommended)</option>
            <option value="parallel">Parallel to length</option>
        </select>

        <button type="button" id="calculate-suggest" style="margin-top:1.1rem;">Calculate & Suggest</button>

        <div id="calc-feedback" style="margin-top:1.2rem; padding:0.9rem; background:#e0f2fe; border-radius:8px; min-height:3.2rem;"></div>
    </div>

    <div style="margin:1.6rem 0;">
        <label style="display:inline-flex; align-items:center; gap:0.5rem;">
            <input type="checkbox" id="picture-framing"> Picture Framing required
        </label>
        <div class="dexerdry-info" id="framing-note" style="display:none; color:var(--warning);">
            → Please add Solid Edge Boards manually for framing
        </div>
    </div>

    <div>
        <label style="display:inline-flex; align-items:center; gap:0.5rem;">
            <input type="checkbox" id="stairs-needed"> Stairs required
        </label>
        <div class="dexerdry-info" id="stairs-note" style="display:none; color:var(--warning);">
            → Please add Solid Edge Boards manually for stairs
        </div>
    </div>
</section>

<section>
    <h2>Line Items</h2>
    <div id="fastener-suggestion" class="dexerdry-info" style="margin-bottom:1.2rem;"></div>

    <table id="order-lines">
        <thead>
            <tr>
                <th>Product</th>
                <th>Color</th>
                <th>Length ft</th>
                <th>Qty</th>
                <th>Dexerdry ft</th>
                <th>Unit Price</th>
                <th>Subtotal</th>
                <th></th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button type="button" id="add-line" style="margin-top:1rem;">+ Add Line Item</button>
</section>

<section>
    <h2>Additional Information</h2>
    <label>Special Instructions / Production Notes</label>
    <textarea id="special-notes" rows="3" placeholder="e.g. special layout requirements, delivery instructions..."></textarea>

    <label>Internal Sales Notes (not visible to customer)</label>
    <textarea id="internal-notes" rows="2"></textarea>
</section>

<section>
    <h2>Shipping & Delivery</h2>
    <label>Shipping Address (leave blank if same as customer)</label>
    <textarea id="shipping-addr" rows="3"></textarea>

    <label>Preferred Delivery Date</label>
    <input type="date" id="pref-delivery">
</section>

<section>
    <h2>Attachments</h2>
    <input type="file" id="attachments" multiple accept="image/*,.pdf">
    <div class="error-text" id="file-size-warning"></div>
</section>

<div class="total-display" id="grand-total-display">
    Estimated Total: $0.00
</div>

<section style="text-align:center; padding-bottom:2rem;">
    <button id="reset-form">Reset Form</button>
    <button id="export-pdf">Export PDF</button>
    <button id="send-email">Prepare Email → Submit</button>

    <div id="submit-feedback" style="margin-top:1.4rem; color:#15803d; font-weight:600; min-height:1.6em;"></div>
</section>

<!-- ─── Color Preview Modal ──────────────────────────────────────────────── -->
<div id="preview-modal" class="modal">
    <div class="modal-content">
        <span class="close-modal" aria-label="Close preview">&times;</span>
        <img id="large-color-preview" src="" alt="Color sample large view" style="max-width:100%; max-height:68vh; border-radius:10px;">
        <div id="color-name-display" style="margin-top:1.1rem; font-size:1.2rem; font-weight:600;"></div>
    </div>
</div>

</div>

<script>
// ============================================================================
//  CONFIGURATION - all important values in one place
// ============================================================================

const CONFIG = {
    prices: {
        system:    8.00,    // grooved 6 + dexdry 2 bundled
        grooved:   6.00,
        solid:     6.00,
        dexdry:    2.00,
        screws:   37.00,
        plugs:   33.79
    },
    board: {
        effectiveWidthFt: (5.5 + 0.125) / 12, // board + gap
        wasteFactor: 1.10,
        standardLengths: [12, 16, 20],
        defaultLength: 16,
        maxLength: 40
    },
    fasteners: {
        joistSpacingInches: 16,
        screwsPerIntersection: 2,
        screwsPerBox: 375
    }
};

const PRODUCTS = {
    system:   { name: "AmeriDex System Boards (Grooved + Dexerdry)", hasColor: true,  isLengthBased: true,  bundleDex: true  },
    grooved:  { name: "Grooved Deck Boards (no Dexerdry)",           hasColor: true,  isLengthBased: true,  bundleDex: false },
    solid:    { name: "Solid Edge Deck Boards",                      hasColor: true,  isLengthBased: true,  bundleDex: false },
    dexdry:   { name: "Dexerdry Seals (standalone)",                 hasColor: false, isLengthBased: true,  bundleDex: false },
    screws:   { name: "Epoxy-Coated Screws",                         hasColor: false, isLengthBased: false, bundleDex: false },
    plugs:    { name: "Color-Matching Plugs",                        hasColor: false, isLengthBased: false, bundleDex: false },
    custom:   { name: "Custom / Manual Item",                        hasColor: false, isLengthBased: false, bundleDex: false }
};

const COLORS = ["Driftwood","Khaki","Slate","Beachwood","Chestnut","Redwood","Hazelnut"];

// ============================================================================
//  STATE & DOM
// ============================================================================

let lines = [];
let deck = { length: 0, width: 0, orientation: "perpendicular" };

const tbody = document.querySelector("#order-lines tbody");
const modal = document.getElementById("preview-modal");
const largeImg = document.getElementById("large-color-preview");
const colorTitle = document.getElementById("color-name-display");
const closeModal = document.querySelector(".close-modal");

// ============================================================================
//  EVENT LISTENERS
// ============================================================================

document.getElementById("use-calculator").addEventListener("change", e => {
    document.getElementById("calculator-panel").style.display = e.target.checked ? "block" : "none";
});

["picture-framing", "stairs-needed"].forEach(id => {
    document.getElementById(id).addEventListener("change", e => {
        document.getElementById(id.replace("-needed","") + "-note").style.display = e.target.checked ? "block" : "none";
    });
});

document.getElementById("add-line").onclick = () => addLine();

document.getElementById("calculate-suggest").onclick = runCalculator;

closeModal.onclick = () => modal.style.display = "none";
modal.onclick = e => { if (e.target === modal) modal.style.display = "none"; };

document.getElementById("reset-form").onclick = () => {
    if (!confirm("Reset entire form? All data will be lost.")) return;
    lines = [];
    renderLines();
    updateTotalsAndHints();
    document.querySelectorAll("input, textarea, select").forEach(el => {
        if (el.type !== "checkbox") el.value = "";
        el.classList.remove("invalid");
    });
    document.querySelectorAll(".error-text").forEach(el => el.textContent = "");
    document.getElementById("use-calculator").checked = false;
    document.getElementById("calculator-panel").style.display = "none";
    document.getElementById("picture-framing").checked = false;
    document.getElementById("stairs-needed").checked = false;
};

document.getElementById("export-pdf").onclick = generatePDF;
document.getElementById("send-email").onclick = prepareEmailSubmission;

// ============================================================================
//  CORE FUNCTIONS
// ============================================================================

function addLine(defaultType = "system") {
    lines.push({
        type: defaultType,
        color: defaultType !== "custom" ? COLORS[0] : "",
        length: CONFIG.board.defaultLength,
        qty: 1,
        dexdryOverride: null, // only used for system boards
        priceOverride: null,
        customDesc: "",
        customUnitPrice: 0
    });
    renderLines();
    updateTotalsAndHints();
}

function renderLines() {
    tbody.innerHTML = "";

    lines.forEach((item, index) => {
        const p = PRODUCTS[item.type] || PRODUCTS.custom;
        const tr = document.createElement("tr");

        // Product
        let td = document.createElement("td");
        td.setAttribute("data-label", "Product");
        const sel = document.createElement("select");
        Object.keys(PRODUCTS).forEach(k => {
            const o = document.createElement("option");
            o.value = k;
            o.textContent = PRODUCTS[k].name;
            if (k === item.type) o.selected = true;
            sel.appendChild(o);
        });
        sel.onchange = () => {
            item.type = sel.value;
            if (!PRODUCTS[item.type].isLengthBased) item.length = null;
            if (item.type !== "system") item.dexdryOverride = null;
            if (item.type !== "custom") {
                item.customDesc = "";
                item.customUnitPrice = 0;
            }
            renderLines();
            updateTotalsAndHints();
        };
        td.appendChild(sel);
        tr.appendChild(td);

        // Color
        td = document.createElement("td");
        td.setAttribute("data-label", "Color");
        if (p.hasColor) {
            const csel = document.createElement("select");
            COLORS.forEach(c => {
                const o = document.createElement("option");
                o.value = c;
                o.textContent = c;
                if (c === item.color) o.selected = true;
                csel.appendChild(o);
            });
            csel.onchange = e => {
                item.color = e.target.value;
                updateTotalsAndHints();
            };

            const preview = document.createElement("img");
            preview.src = `colors/${item.color.toLowerCase()}.jpg`; // ← real path when available
            preview.className = "preview-img";
            preview.alt = `${item.color} color preview`;
            preview.title = "Click to enlarge";
            preview.onerror = () => preview.src = "https://via.placeholder.com/52?text=?";
            preview.onclick = () => {
                largeImg.src = preview.src;
                colorTitle.textContent = item.color;
                modal.style.display = "flex";
            };

            td.append(csel, preview);
        }
        tr.appendChild(td);

        // Length
        td = document.createElement("td");
        td.setAttribute("data-label", "Length ft");
        if (p.isLengthBased) {
            if (["system","grooved","solid"].includes(item.type)) {
                const lsel = document.createElement("select");
                CONFIG.board.standardLengths.forEach(l => {
                    const o = document.createElement("option");
                    o.value = l;
                    o.textContent = l;
                    if (l === item.length) o.selected = true;
                    lsel.appendChild(o);
                });
                const customOpt = document.createElement("option");
                customOpt.value = "custom";
                customOpt.textContent = "Custom";
                if (!CONFIG.board.standardLengths.includes(item.length)) customOpt.selected = true;
                lsel.appendChild(customOpt);

                lsel.onchange = () => {
                    if (lsel.value === "custom") {
                        const val = prompt(`Custom length (1–${CONFIG.board.maxLength} ft):`, item.length || CONFIG.board.defaultLength);
                        const num = parseFloat(val);
                        if (!isNaN(num) && num > 0 && num <= CONFIG.board.maxLength) {
                            item.length = num;
                        } else {
                            alert(`Please enter a number between 1 and ${CONFIG.board.maxLength}`);
                        }
                    } else {
                        item.length = parseFloat(lsel.value);
                    }
                    renderLines();
                    updateTotalsAndHints();
                };

                td.appendChild(lsel);
            } else {
                // standalone dexdry
                const inp = document.createElement("input");
                inp.type = "number";
                inp.step = "0.1";
                inp.min = "0.1";
                inp.value = item.length || "";
                inp.oninput = e => {
                    item.length = parseFloat(e.target.value) || 0;
                    updateTotalsAndHints();
                };
                td.appendChild(inp);
            }
        }
        tr.appendChild(td);

        // Quantity
        td = document.createElement("td");
        td.setAttribute("data-label", "Qty");
        const q = document.createElement("input");
        q.type = "number";
        q.min = "1";
        q.step = "1";
        q.value = item.qty;
        q.oninput = e => {
            item.qty = Math.max(1, parseInt(e.target.value) || 1);
            updateTotalsAndHints();
        };
        td.appendChild(q);

        if (item.type === "custom") {
            const wrapper = document.createElement("div");
            wrapper.className = "custom-fields";

            const desc = document.createElement("input");
            desc.placeholder = "Description";
            desc.value = item.customDesc;
            desc.oninput = e => item.customDesc = e.target.value;

            const unitp = document.createElement("input");
            unitp.type = "number";
            unitp.step = "0.01";
            unitp.min = "0";
            unitp.placeholder = "Unit $";
            unitp.value = item.customUnitPrice;
            unitp.oninput = e => {
                item.customUnitPrice = parseFloat(e.target.value) || 0;
                updateTotalsAndHints();
            };

            wrapper.append(desc, unitp);
            td.appendChild(wrapper);
        }
        tr.appendChild(td);

        // Dexerdry ft (only for system boards)
        td = document.createElement("td");
        td.setAttribute("data-label", "Dexerdry ft");
        if (item.type === "system") {
            const calcFt = item.length * (item.qty - 1) * CONFIG.board.wasteFactor;
            const displayFt = item.dexdryOverride !== null ? item.dexdryOverride : calcFt;

            const span = document.createElement("span");
            span.textContent = displayFt.toFixed(1);
            span.style.fontWeight = item.dexdryOverride !== null ? "600" : "normal";
            span.style.color = item.dexdryOverride !== null ? "var(--primary)" : "#64748b";

            const overrideBtn = document.createElement("button");
            overrideBtn.textContent = item.dexdryOverride !== null ? "Reset" : "Override";
            overrideBtn.style.fontSize = "0.8rem";
            overrideBtn.style.padding = "0.35rem 0.7rem";
            overrideBtn.style.marginLeft = "0.6rem";
            overrideBtn.onclick = () => {
                if (item.dexdryOverride !== null) {
                    item.dexdryOverride = null;
                } else {
                    const val = prompt("Override Dexerdry length (ft):", displayFt.toFixed(1));
                    const num = parseFloat(val);
                    if (!isNaN(num) && num >= 0) {
                        item.dexdryOverride = num;
                    }
                }
                renderLines();
                updateTotalsAndHints();
            };

            td.append(span, overrideBtn);
        }
        tr.appendChild(td);

        // Unit Price
        td = document.createElement("td");
        td.setAttribute("data-label", "Unit Price");
        const priceInput = document.createElement("input");
        priceInput.type = "number";
        priceInput.step = "0.01";
        priceInput.min = "0";
        const defaultPrice = item.type === "custom" ? item.customUnitPrice : CONFIG.prices[item.type] || 0;
        priceInput.placeholder = defaultPrice.toFixed(2);
        priceInput.value = item.priceOverride ?? "";
        priceInput.oninput = e => {
            item.priceOverride = parseFloat(e.target.value);
            updateTotalsAndHints();
        };
        td.appendChild(priceInput);
        tr.appendChild(td);

        // Subtotal
        td = document.createElement("td");
        td.setAttribute("data-label", "Subtotal");
        td.id = `subtotal-${index}`;
        tr.appendChild(td);

        // Remove
        td = document.createElement("td");
        td.setAttribute("data-label", "");
        const removeBtn = document.createElement("button");
        removeBtn.textContent = "×";
        removeBtn.className = "danger";
        removeBtn.onclick = () => {
            lines.splice(index, 1);
            renderLines();
            updateTotalsAndHints();
        };
        td.appendChild(removeBtn);
        tr.appendChild(td);

        tbody.appendChild(tr);
    });
}

function getLineSubtotal(item) {
    const basePrice = item.priceOverride ?? CONFIG.prices[item.type] ?? 0;

    if (item.type === "system") {
        const boardFt = item.qty * (item.length || 0);
        const dexFt = item.dexdryOverride !== null ? item.dexdryOverride : (item.qty - 1) * (item.length || 0) * CONFIG.board.wasteFactor;
        return (boardFt * CONFIG.prices.grooved) + (dexFt * CONFIG.prices.dexdry);
    }

    if (["system","grooved","solid","dexdry"].includes(item.type)) {
        return item.qty * (item.length || 0) * basePrice;
    }

    return item.qty * basePrice;
}

function updateTotalsAndHints() {
    let total = 0;
    let groovedCount = 0;

    lines.forEach((item, i) => {
        const sub = getLineSubtotal(item);
        total += sub;
        document.getElementById(`subtotal-${i}`).textContent = "$" + sub.toFixed(2);

        if (["system","grooved"].includes(item.type)) {
            groovedCount += item.qty;
        }
    });

    document.getElementById("grand-total-display").textContent =
        `Estimated Total: $${total.toFixed(2)}`;

    // Fastener hint
    if (groovedCount > 0 && deck.length > 0) {
        const span = deck.orientation === "perpendicular" ? deck.length : deck.width;
        const run = deck.orientation === "perpendicular" ? deck.width : deck.length;

        const joists = Math.floor(span * 12 / CONFIG.fasteners.joistSpacingInches) + 1;
        const intersections = groovedCount * joists;
        const totalScrews = intersections * CONFIG.fasteners.screwsPerIntersection;
        const screwBoxes = Math.ceil(totalScrews / CONFIG.fasteners.screwsPerBox);

        document.getElementById("fastener-suggestion").innerHTML =
            `<strong>Fastener Estimate (add manually):</strong><br>` +
            `≈ ${screwBoxes} boxes screws<br>` +
            `≈ ${screwBoxes} boxes plugs`;
    } else {
        document.getElementById("fastener-suggestion").innerHTML = "";
    }
}

function runCalculator() {
    deck.length = parseFloat(document.getElementById("deck-length").value) || 0;
    deck.width  = parseFloat(document.getElementById("deck-width").value) || 0;
    deck.orientation = document.getElementById("board-orientation").value;

    if (deck.length < 1 || deck.width < 1) {
        alert("Please enter both length and width (minimum 1 ft)");
        return;
    }

    const span = deck.orientation === "perpendicular" ? deck.length : deck.width;
    const run  = deck.orientation === "perpendicular" ? deck.width : deck.length;

    const boards = Math.ceil((span / CONFIG.board.effectiveWidthFt) * CONFIG.board.wasteFactor);
    const dexdry = (boards - 1) * run * CONFIG.board.wasteFactor;

    const msg = `
        <strong>Recommended AmeriDex System Boards:</strong><br>
        • ${boards} boards @ ${run.toFixed(1)} ft<br>
        • Total board length: ${(boards * run).toFixed(1)} ft<br>
        • Dexerdry needed: ${dexdry.toFixed(1)} ft<br>
        <em>(includes ${((CONFIG.board.wasteFactor-1)*100).toFixed(0)}% waste)</em>
    `;

    document.getElementById("calc-feedback").innerHTML = msg;

    if (confirm("Add suggested System Boards to order?")) {
        addLine("system");
        const last = lines[lines.length-1];
        last.qty = boards;
        last.length = Math.min(CONFIG.board.standardLengths.reduce((a,b)=>Math.abs(b-run)<Math.abs(a-run)?b:a), run);
        renderLines();
        updateTotalsAndHints();
    }
}

function validateForm() {
    let valid = true;

    // Required fields
    const required = [
        {id:"cust-name",    label:"Name"},
        {id:"cust-company", label:"Company"},
        {id:"cust-address", label:"Address"},
        {id:"cust-phone",   label:"Phone"},
        {id:"cust-email",   label:"Email"}
    ];

    required.forEach(f => {
        const el = document.getElementById(f.id);
        const err = document.getElementById("err-" + f.id.split("-")[1]);
        if (!el.value.trim()) {
            err.textContent = `${f.label} is required`;
            el.classList.add("invalid");
            valid = false;
        } else {
            err.textContent = "";
            el.classList.remove("invalid");
        }
    });

    // Email format
    const email = document.getElementById("cust-email");
    if (email.value && !/\S+@\S+\.\S+/.test(email.value)) {
        document.getElementById("err-email").textContent = "Invalid email format";
        email.classList.add("invalid");
        valid = false;
    }

    // File size
    let totalSize = 0;
    [...document.getElementById("attachments").files].forEach(f => totalSize += f.size);
    document.getElementById("file-size-warning").textContent =
        totalSize > 10*1024*1024 ? "Total attachments exceed 10 MB limit" : "";
    if (totalSize > 10*1024*1024) valid = false;

    // Line items basic sanity
    if (lines.length === 0) {
        alert("Please add at least one line item");
        return false;
    }

    for (let item of lines) {
        if (item.qty < 1) {
            alert("All quantities must be at least 1");
            return false;
        }
        if (["system","grooved","solid","dexdry"].includes(item.type) && (item.length || 0) <= 0) {
            alert("Length must be greater than 0 ft for length-based products");
            return false;
        }
    }

    return valid;
}

function generateOrderText() {
    let text = "AmeriDex Order Submission\n\n";

    text += "CUSTOMER:\n";
    text += `Name:    ${document.getElementById("cust-name").value}\n`;
    text += `Company: ${document.getElementById("cust-company").value}\n`;
    text += `Address: ${document.getElementById("cust-address").value.replace(/\n/g," | ")}\n`;
    text += `Phone:   ${document.getElementById("cust-phone").value}\n`;
    text += `Email:   ${document.getElementById("cust-email").value}\n\n`;

    text += "ORDER ITEMS:\n";
    lines.forEach(item => {
        const p = PRODUCTS[item.type];
        const color = item.color ? ` (${item.color})` : "";
        const length = item.length ? ` × ${item.length.toFixed(1)} ft` : "";
        const price = item.priceOverride ?? CONFIG.prices[item.type] ?? item.customUnitPrice ?? 0;
        const sub = getLineSubtotal(item);

        let desc = p.name;
        if (item.type === "custom") desc = item.customDesc || "Custom item";

        text += `• ${desc}${color}${length}    Qty: ${item.qty}    $${price.toFixed(2)} ea    Subtotal: $${sub.toFixed(2)}\n`;
    });

    const grand = lines.reduce((sum, item) => sum + getLineSubtotal(item), 0);
    text += `\nTOTAL ESTIMATE: $${grand.toFixed(2)}\n\n`;

    text += "SHIPPING:\n";
    const ship = document.getElementById("shipping-addr").value.trim();
    text += ship ? ship.replace(/\n/g," | ") : "(same as customer address)\n";
    const date = document.getElementById("pref-delivery").value;
    if (date) text += `Preferred date: ${date}\n\n`;

    const notes = document.getElementById("special-notes").value.trim();
    if (notes) text += `SPECIAL INSTRUCTIONS:\n${notes}\n\n`;

    const internal = document.getElementById("internal-notes").value.trim();
    if (internal) text += `INTERNAL SALES NOTES:\n${internal}\n`;

    return text;
}

function prepareEmailSubmission() {
    if (!validateForm()) return;

    const body = generateOrderText();
    const name = document.getElementById("cust-name").value.trim() || "Customer";
    const subject = `AmeriDex Order – ${name} (${new Date().toLocaleDateString()})`;

    window.location.href = `mailto:sales@ameridex.com?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;

    document.getElementById("submit-feedback").textContent =
        "Email client opened. Remember to attach files manually if needed!";
}

function generatePDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    let y = 18;

    doc.setFontSize(20);
    doc.setTextColor(37,99,235);
    doc.text("AmeriDex Order Estimate", 105, y, {align:"center"});
    y += 12;

    doc.setFontSize(11);
    doc.setTextColor(0);
    doc.text("Customer Information", 15, y);
    y += 8;

    doc.setFontSize(10);
    const cust = [
        ["Name:", document.getElementById("cust-name").value],
        ["Company:", document.getElementById("cust-company").value],
        ["Address:", document.getElementById("cust-address").value],
        ["Phone:", document.getElementById("cust-phone").value],
        ["Email:", document.getElementById("cust-email").value]
    ];

    cust.forEach(([label,val]) => {
        doc.text(label, 20, y);
        doc.text(val.substring(0,80), 50, y); // truncate long lines
        y += 7;
        if (y > 270) { doc.addPage(); y = 20; }
    });

    y += 8;
    doc.setFontSize(11);
    doc.text("Order Items", 15, y);
    y += 8;

    doc.setFontSize(9);
    lines.forEach(item => {
        const p = PRODUCTS[item.type];
        const color = item.color ? ` (${item.color})` : "";
        const length = item.length ? ` × ${item.length} ft` : "";
        const price = item.priceOverride ?? CONFIG.prices[item.type] ?? item.customUnitPrice ?? 0;
        const sub = getLineSubtotal(item);

        let name = p.name;
        if (item.type === "custom") name = item.customDesc || "Custom";

        const line = `${name}${color}${length} × ${item.qty}   $${price.toFixed(2)}   $${sub.toFixed(2)}`;
        doc.text(line.substring(0,95), 20, y);
        y += 7;
        if (y > 270) { doc.addPage(); y = 20; }
    });

    const grand = lines.reduce((s,i)=>s+getLineSubtotal(i),0);
    y += 5;
    doc.setFontSize(12);
    doc.setTextColor(37,99,235);
    doc.text(`Estimated Total: $${grand.toFixed(2)}`, 20, y);

    y += 12;
    const special = document.getElementById("special-notes").value.trim();
    if (special) {
        doc.setFontSize(11);
        doc.setTextColor(0);
        doc.text("Special Instructions:", 15, y);
        y += 7;
        doc.setFontSize(9);
        special.split("\n").forEach(line => {
            doc.text(line.substring(0,90), 20, y);
            y += 6;
            if (y > 270) { doc.addPage(); y = 20; }
        });
    }

    doc.save(`AmeriDex_Order_${new Date().toISOString().slice(0,10)}.pdf`);
}

// ============================================================================
//  INITIALIZATION
// ============================================================================

renderLines();
updateTotalsAndHints();

// Optional: start with one system board line for faster ordering
// addLine("system");

</script>
</body>
</html>
